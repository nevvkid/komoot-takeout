<!DOCTYPE html>
 <html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>komoot-takeout</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .hidden {
            display: none;
        }
        /* Custom background color */
        body {
            background-color: #f5f4e9;
        }
        .bg-4f840d { 
            background-color: #4f840d;
        }
        /* Floating progress bar */
        .floating-progress {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            z-index: 100;
        }
        /* Increase contrast for progress bar */
        .bg-blue-500 {
            background-color: #0077d9;
        }
        /* Custom scrollbar for logs */
        .log-container {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.5rem;
            background-color: #f8fafc;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        .log-container::-webkit-scrollbar {
            width: 8px;
        }
        .log-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .log-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .log-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Tab styling */
        .tab {
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        .tab.active {
            border-bottom: 2px solid #4f840d;
            color: #4f840d;
            font-weight: 700;
        }
        button {
            font-weight: 700;
        }
        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 0.9;
            color:#fff;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        /* Desktop application specific styling */
        .desktop-only {
            display: none; /* Hidden by default, shown if in desktop app */
        }
        
        /* Collection enhancement status badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 0 auto;
        }
        .bg-secondary {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        .bg-success {
            background-color: #10b981;
            color: white;
        }
        .bg-warning {
            background-color: #f59e0b;
            color: white;
        }

        /* Table cell styling */
        .collection-name-link {
            color: #3182ce;
            text-decoration: none;
        }
        .collection-name-link:hover {
            text-decoration: underline;
        }
        
        td.status-cell {
            text-align: center;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">komoot-takeout</h1>
                <p class="text-gray-600">Get your tours. They're yours.</p>
            </div>
            <div class="text-sm text-gray-600">
                <a href="https://github.com/nevvkid/komoot-takeout" target="_blank" class="hover:text-blue-500">
                    GitHub
                </a>
            </div>
        </div>

        <!-- Tabs navigation -->
        <div class="flex mb-4 border-b border-gray-200">
            <div id="tab-tours" class="tab active px-4 py-2">
                Tours
            </div>
            <div id="tab-collections" class="tab px-4 py-2">
                Collections
            </div>
        </div>

        <!-- Tours Tab Content -->
        <div id="content-tours" class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4">Tours Export</h2>
            
            <div class="mb-6">
                <label class="inline-flex items-center">
                    <input type="checkbox" id="anonymous-checkbox" class="form-checkbox h-5 w-5 text-blue-600">
                    <span class="ml-2 text-gray-700">Anonymous Export (Limited to single tour)</span>
                </label>
            </div>
            
            <div id="login-section">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="email" class="block text-gray-700 mb-2">Email</label>
                        <input type="email" id="email" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="password" class="block text-gray-700 mb-2">Password</label>
                        <input type="password" id="password" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <div id="tour-selection-section" class="mb-4">
                <div class="flex flex-wrap items-center gap-3 mb-3">
                    <div class="flex items-center">
                        <input type="radio" id="all-tours" name="tour-selection" value="all" checked
                            class="form-radio h-5 w-5 text-blue-600">
                        <label for="all-tours" class="ml-2 text-gray-700">All Tours</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="single-tour" name="tour-selection" value="single"
                            class="form-radio h-5 w-5 text-blue-600">
                        <label for="single-tour" class="ml-2 text-gray-700">Single Tour</label>
                    </div>
                    <div id="tour-id-input" class="hidden flex-grow">
                        <label for="tour-id" class="block text-gray-700 mb-1">Tour ID</label>
                        <input type="text" id="tour-id" placeholder="e.g., 1234567890"
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div id="filter-section">
                    <label for="filter-type" class="block text-gray-700 mb-2">Filter Tours</label>
                    <select id="filter-type" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">All Tours</option>
                        <option value="tour_recorded">Recorded Only</option>
                        <option value="tour_planned">Planned Only</option>
                    </select>
                </div>
            </div>

            <!-- Modified Output Directory with Folder Selection -->
            <div class="mb-4">
                <label for="output-dir" class="block text-gray-700 mb-2">Output Directory</label>
                <div class="flex items-center">
                    <input type="text" id="output-dir" class="flex-grow px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="button" class="ml-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 folder-selection-btn" data-target="output-dir">
                        Browse...
                    </button>
                </div>
            </div>

            <!-- Options toggle button -->
            <div class="mb-4">
                <button id="options-toggle-btn" class="px-4 py-2 bg-white text-gray-800 rounded-lg hover:bg-gray-300 border border-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">
                    Show Options
                </button>
            </div>

            <div id="options-section" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <h3 class="font-semibold mb-2">GPX Options</h3>
                        <div class="space-y-2">
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="no-poi" class="form-checkbox h-5 w-5 text-blue-600">
                                <span class="ml-2 text-gray-700 tooltip">
                                    No POIs
                                    <span class="tooltiptext">Exclude points of interest from the GPX file</span>
                                </span>
                            </label>
                            <div class="block">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="skip-existing" class="form-checkbox h-5 w-5 text-blue-600" checked>
                                    <span class="ml-2 text-gray-700 tooltip">
                                        Skip Existing
                                        <span class="tooltiptext">Skip tours that already have a GPX file</span>
                                    </span>
                                </label>
                            </div>
                            <div class="block">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="id-filename" class="form-checkbox h-5 w-5 text-blue-600">
                                    <span class="ml-2 text-gray-700 tooltip">
                                        ID Filename
                                        <span class="tooltiptext">Use only tour ID as filename</span>
                                    </span>
                                </label>
                            </div>
                            <div class="block">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="add-date" class="form-checkbox h-5 w-5 text-blue-600" checked>
                                    <span class="ml-2 text-gray-700 tooltip">
                                        Add Date Prefix
                                        <span class="tooltiptext">Add date to filename (e.g., "2023-04-15_")</span>
                                    </span>
                                </label>
                            </div>
                            <div class="block">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="download-images" class="form-checkbox h-5 w-5 text-blue-600">
                                    <span class="ml-2 text-gray-700 tooltip">
                                        Download Images
                                        <span class="tooltiptext">Download all images associated with tours</span>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2">Advanced Options</h3>
                        <div class="space-y-3">
                            <div>
                                <label for="max-title-length" class="block text-gray-700 mb-1 tooltip">
                                    Max Title Length
                                    <span class="tooltiptext">Limit title length in GPX file (-1 for no limit, 0 for ID only)</span>
                                </label>
                                <input type="number" id="max-title-length" value="-1" min="-1"
                                    class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="max-desc-length" class="block text-gray-700 mb-1 tooltip">
                                    Max Description Length
                                    <span class="tooltiptext">Limit description length in GPX file (-1 for no limit)</span>
                                </label>
                                <input type="number" id="max-desc-length" value="-1" min="-1"
                                    class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                </div>

                <div id="chunking-section" class="mb-6 hidden">
                    <h3 class="font-semibold mb-2">Chunking Options <span class="text-xs text-gray-500">(For large collections)</span></h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="chunk-size" class="block text-gray-700 mb-1 tooltip">
                                Chunk Size
                                <span class="tooltiptext">Number of tours to process in each chunk (0 for all)</span>
                            </label>
                            <input type="number" id="chunk-size" value="0" min="0"
                                class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="chunk-start" class="block text-gray-700 mb-1 tooltip">
                                Start Index
                                <span class="tooltiptext">Starting index for processing (0 for beginning)</span>
                            </label>
                            <input type="number" id="chunk-start" value="0" min="0"
                                class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-wrap gap-3 mb-6">
                <button id="count-tours-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    Count Tours
                </button>
                <button id="start-export-btn" class="px-4 py-2 bg-4f840d text-white rounded-lg hover:bg-446f0b focus:outline-none focus:ring-2 focus:ring-4f840d focus:ring-opacity-50">
                    Start Tours Export
                </button>
                <button id="export-clear-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 hidden">
                    Clear Results
                </button>
            </div>

            <div id="tours-count-result" class="p-3 bg-blue-100 text-blue-800 rounded-lg mb-4 hidden">
                <p id="tours-count-text"></p>
            </div>

            <div id="status-section" class="hidden">
                <h3 class="text-lg font-semibold mb-2">Processing Status</h3>
                <div class="mb-2">
                    <div class="flex justify-between mb-1">
                        <span id="status-text" class="text-sm text-gray-700">Idle</span>
                        <span id="status-percent" class="text-sm text-gray-700">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="status-bar" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <div class="mb-2 text-sm">
                    <span id="status-completed">0</span> / <span id="status-total">0</span> tours processed
                </div>
                <div id="log-container" class="log-container">
                    <div id="log-content"></div>
                </div>
            </div>

            <div id="results-section" class="mt-6 hidden">
                <h3 class="text-lg font-semibold mb-4">Results</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 border-b border-gray-200 bg-gray-50 text-left text-xs leading-4 font-medium text-gray-500 uppercase tracking-wider">
                                    ID
                                </th>
                                <th class="px-6 py-3 border-b border-gray-200 bg-gray-50 text-left text-xs leading-4 font-medium text-gray-500 uppercase tracking-wider">
                                    Name
                                </th>
                                <th class="px-6 py-3 border-b border-gray-200 bg-gray-50 text-left text-xs leading-4 font-medium text-gray-500 uppercase tracking-wider">
                                    Date
                                </th>
                                <th class="px-6 py-3 border-b border-gray-200 bg-gray-50 text-left text-xs leading-4 font-medium text-gray-500 uppercase tracking-wider">
                                    Type
                                </th>
                                <th class="px-6 py-3 border-b border-gray-200 bg-gray-50 text-left text-xs leading-4 font-medium text-gray-500 uppercase tracking-wider">
                                    Distance
                                </th>
                                <th class="px-6 py-3 border-b border-gray-200 bg-gray-50 text-left text-xs leading-4 font-medium text-gray-500 uppercase tracking-wider">
                                    Duration
                                </th>
                                <th class="px-6 py-3 border-b border-gray-200 bg-gray-50 text-left text-xs leading-4 font-medium text-gray-500 uppercase tracking-wider">
                                    Up
                                </th>
                                <th class="px-6 py-3 border-b border-gray-200 bg-gray-50 text-left text-xs leading-4 font-medium text-gray-500 uppercase tracking-wider">
                                    Down
                                </th>
                                <th class="px-6 py-3 border-b border-gray-200 bg-gray-50 text-left text-xs leading-4 font-medium text-gray-500 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                            <!-- Results will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Collections Tab Content -->
        <div id="content-collections" class="bg-white p-6 rounded-lg shadow-md mb-8 hidden">
            <h2 class="text-xl font-semibold mb-4">Collections Export</h2>
            
            <div class="mb-6">
                <div class="mb-4">
                    <label for="collection-urls" class="block text-gray-700 mb-2">URL of your public collections</label>
                    <textarea id="collection-urls" rows="1" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                        placeholder="e.g. https://www.komoot.com/user/markus/collections/personal"></textarea>
                </div>
                <button id="scrape-public-btn" class="px-4 py-2 bg-4f840d text-white rounded-lg hover:bg-446f0b focus:outline-none focus:ring-2 focus:ring-4f840d focus:ring-opacity-50">
                    Get Public Collections
                </button>
            </div>

            <div id="collections-status-section" class="hidden">
                <div class="mb-2">
                    <div class="flex justify-between mb-1">
                        <span id="collections-status-text" class="text-sm text-gray-700">Idle</span>
                        <span id="collections-status-percent" class="text-sm text-gray-700">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="collections-status-bar" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <div class="mb-2 text-sm">
                    <span id="collections-status-completed">0</span> / <span id="collections-status-total">0</span> processed
                </div>
                <div id="collections-log-container" class="log-container">
                    <div id="collections-log-content"></div>
                </div>
            </div>

            <div id="collections-results-section" class="mt-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Collections Found</h3>
                    <div class="flex gap-2">
                        <button id="clear-collections-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
                            Clear Collections
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 border-b border-gray-200 bg-gray-50 text-left text-xs leading-4 font-medium text-gray-500 uppercase tracking-wider">
                                    Select
                                </th>
                                <th class="px-6 py-3 border-b border-gray-200 bg-gray-50 text-left text-xs leading-4 font-medium text-gray-500 uppercase tracking-wider">
                                    Name
                                </th>
                                <th class="px-6 py-3 border-b border-gray-200 bg-gray-50 text-left text-xs leading-4 font-medium text-gray-500 uppercase tracking-wider">
                                    ID
                                </th>
                                <th class="px-6 py-3 border-b border-gray-200 bg-gray-50 text-left text-xs leading-4 font-medium text-gray-500 uppercase tracking-wider">
                                    Slug
                                </th>
                                <th class="px-6 py-3 border-b border-gray-200 bg-gray-50 text-left text-xs leading-4 font-medium text-gray-500 uppercase tracking-wider">
                                    Tours
                                </th>
                                <th class="px-6 py-3 border-b border-gray-200 bg-gray-50 text-left text-xs leading-4 font-medium text-gray-500 uppercase tracking-wider">
                                    Status
                                </th>
                            </tr>
                        </thead>
                        <tbody id="collections-table-body">
                            <!-- Collections will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="download-collections-section" class="mt-6 hidden">
                <h3 class="text-lg font-semibold mb-4">Download Collection Tours</h3>
                
                <div class="p-3 bg-blue-100 text-blue-800 rounded-lg mb-4">
                    <p><strong>Workflow:</strong> 
                        1. Select collections from the table above 
                        2. Choose to either enhance first (recommended for better metadata) or download directly
                    </p>
                </div>
                
                <!-- Modified Output Directory with Folder Selection -->
                <div class="mb-4">
                    <label for="collections-output-dir" class="block text-gray-700 mb-2">Output Directory</label>
                    <div class="flex items-center">
                        <input type="text" id="collections-output-dir" class="flex-grow px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="button" class="ml-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 folder-selection-btn" data-target="collections-output-dir">
                            Browse...
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <h4 class="font-semibold mb-2">Download Options</h4>
                        <div class="space-y-2">
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="collections-include-metadata" class="form-checkbox h-5 w-5 text-blue-600" checked>
                                <span class="ml-2 text-gray-700 tooltip">
                                    Include Metadata
                                    <span class="tooltiptext">Save collection metadata with GPX files</span>
                                </span>
                            </label>
                            <div class="block">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="collections-download-images" class="form-checkbox h-5 w-5 text-blue-600">
                                    <span class="ml-2 text-gray-700 tooltip">
                                        Download Images
                                        <span class="tooltiptext">Download all images associated with tour</span>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">GPX Options</h4>
                        <div class="space-y-2">
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="collections-no-poi" class="form-checkbox h-5 w-5 text-blue-600">
                                <span class="ml-2 text-gray-700 tooltip">
                                    No POIs
                                    <span class="tooltiptext">Exclude points of interest from the GPX file</span>
                                </span>
                            </label>
                            <div class="block">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="collections-skip-existing" class="form-checkbox h-5 w-5 text-blue-600" checked>
                                    <span class="ml-2 text-gray-700 tooltip">
                                        Skip Existing
                                        <span class="tooltiptext">Skip tours that already have a GPX file</span>
                                    </span>
                                </label>
                            </div>
                            <div class="block">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="collections-add-date" class="form-checkbox h-5 w-5 text-blue-600" checked>
                                    <span class="ml-2 text-gray-700 tooltip">
                                        Add Date Prefix
                                        <span class="tooltiptext">Add date to filename (e.g., "2023-04-15_")</span>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-2 mb-4">
                    <button id="enhance-collections-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 hidden">
                        Enhance Collections First
                    </button>
                    <button id="download-collection-tours-btn" class="px-4 py-2 bg-4f840d text-white rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                        Download Selected Collections
                    </button>
                </div>
            </div>
        </div>

        <!-- Floating progress indicator (only shown during processing) -->
        <div id="floating-progress" class="floating-progress hidden p-4 bg-white shadow-lg rounded-lg">
            <div class="flex justify-between mb-1">
                <span id="floating-status-text" class="text-sm text-gray-700">Processing...</span>
                <span id="floating-status-percent" class="text-sm text-gray-700">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="floating-status-bar" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <div class="mt-2 text-sm text-center">
                <span id="floating-status-completed">0</span> / <span id="floating-status-total">0</span> processed
            </div>
        </div>

        <!-- Desktop app info banner -->
        <div id="desktop-app-info" class="desktop-only p-4 bg-blue-100 text-blue-800 rounded-lg mb-4 text-center">
            <p>Running as desktop application. Files will be saved to the selected folder.</p>
        </div>
    </div>

    <script>
        // Check if running in pywebview
        const isPywebview = window.pywebview !== undefined;
        
        // If running in pywebview, show desktop-only elements
        if (isPywebview) {
            document.querySelectorAll('.desktop-only').forEach(el => {
                el.style.display = 'block';
            });
        }
        
        // Function to extract slug from URL or collection name
        function extractSlug(url, name) {
            // Try to extract slug from URL first
            if (url) {
                const match = url.match(/\/collection\/\d+\/?-?([a-z0-9-]+)?/);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            // If no URL or no slug in URL, generate slug from name
            if (name) {
                return name.toLowerCase()
                    .replace(/[^\w\s-]/g, '') // Remove special characters
                    .replace(/\s+/g, '-')     // Replace spaces with hyphens
                    .replace(/-+/g, '-')      // Remove consecutive hyphens
                    .substring(0, 50);        // Limit length
            }
            
            return "";
        }
        
        // Function to fetch and update the selected folder
        function updateSelectedFolder() {
            fetch('/api/selected-folder')
                .then(response => response.json())
                .then(data => {
                    const outputDirInput = document.getElementById('output-dir');
                    const collectionsOutputDirInput = document.getElementById('collections-output-dir');
                    
                    if (outputDirInput) outputDirInput.value = data.path;
                    if (collectionsOutputDirInput) collectionsOutputDirInput.value = data.path;
                    
                    // Display the folder selection elements if pywebview is available
                    document.querySelectorAll('.folder-selection-btn').forEach(btn => {
                        btn.style.display = isPywebview ? 'inline-block' : 'none';
                    });
                })
                .catch(error => console.error('Error fetching selected folder:', error));
        }

        // DOM Elements
        const tabTours = document.getElementById('tab-tours');
        const tabCollections = document.getElementById('tab-collections');
        const contentTours = document.getElementById('content-tours');
        const contentCollections = document.getElementById('content-collections');
        
        // Tours tab elements
        const anonymousCheckbox = document.getElementById('anonymous-checkbox');
        const loginSection = document.getElementById('login-section');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const allToursRadio = document.getElementById('all-tours');
        const singleTourRadio = document.getElementById('single-tour');
        const tourIdInput = document.getElementById('tour-id-input');
        const tourIdField = document.getElementById('tour-id');
        const filterSection = document.getElementById('filter-section');
        const filterTypeSelect = document.getElementById('filter-type');
        const outputDirInput = document.getElementById('output-dir');
        const optionsSection = document.getElementById('options-section');
        const optionsToggleBtn = document.getElementById('options-toggle-btn');
        const noPoiCheckbox = document.getElementById('no-poi');
        const skipExistingCheckbox = document.getElementById('skip-existing');
        const idFilenameCheckbox = document.getElementById('id-filename');
        const addDateCheckbox = document.getElementById('add-date');
        const maxTitleLengthInput = document.getElementById('max-title-length');
        const maxDescLengthInput = document.getElementById('max-desc-length');
        const downloadImagesCheckbox = document.getElementById('download-images');
        const chunkingSection = document.getElementById('chunking-section');
        const chunkSizeInput = document.getElementById('chunk-size');
        const chunkStartInput = document.getElementById('chunk-start');
        const countToursBtn = document.getElementById('count-tours-btn');
        const startExportBtn = document.getElementById('start-export-btn');
        const exportClearBtn = document.getElementById('export-clear-btn');
        const toursCountResult = document.getElementById('tours-count-result');
        const toursCountText = document.getElementById('tours-count-text');
        const statusSection = document.getElementById('status-section');
        const statusText = document.getElementById('status-text');
        const statusPercent = document.getElementById('status-percent');
        const statusBar = document.getElementById('status-bar');
        const statusCompleted = document.getElementById('status-completed');
        const statusTotal = document.getElementById('status-total');
        const logContainer = document.getElementById('log-container');
        const logContent = document.getElementById('log-content');
        const resultsSection = document.getElementById('results-section');
        const resultsTableBody = document.getElementById('results-table-body');
        
        // Collections tab elements
        const collectionUrlsInput = document.getElementById('collection-urls');
        const scrapePublicBtn = document.getElementById('scrape-public-btn');
        const collectionsStatusSection = document.getElementById('collections-status-section');
        const collectionsStatusText = document.getElementById('collections-status-text');
        const collectionsStatusPercent = document.getElementById('collections-status-percent');
        const collectionsStatusBar = document.getElementById('collections-status-bar');
        const collectionsStatusCompleted = document.getElementById('collections-status-completed');
        const collectionsStatusTotal = document.getElementById('collections-status-total');
        const collectionsLogContainer = document.getElementById('collections-log-container');
        const collectionsLogContent = document.getElementById('collections-log-content');
        const collectionsResultsSection = document.getElementById('collections-results-section');
        const collectionsTableBody = document.getElementById('collections-table-body');
        const clearCollectionsBtn = document.getElementById('clear-collections-btn');
        const downloadCollectionsSection = document.getElementById('download-collections-section');
        const collectionsOutputDirInput = document.getElementById('collections-output-dir');
        const collectionsIncludeMetadataCheckbox = document.getElementById('collections-include-metadata');
        const collectionsDownloadImagesCheckbox = document.getElementById('collections-download-images');
        const collectionsNoPoiCheckbox = document.getElementById('collections-no-poi');
        const collectionsSkipExistingCheckbox = document.getElementById('collections-skip-existing');
        const collectionsAddDateCheckbox = document.getElementById('collections-add-date');
        const downloadCollectionToursBtn = document.getElementById('download-collection-tours-btn');
        
        // Floating progress elements
        const floatingProgress = document.getElementById('floating-progress');
        const floatingStatusText = document.getElementById('floating-status-text');
        const floatingStatusPercent = document.getElementById('floating-status-percent');
        const floatingStatusBar = document.getElementById('floating-status-bar');
        const floatingStatusCompleted = document.getElementById('floating-status-completed');
        const floatingStatusTotal = document.getElementById('floating-status-total');
        
        // State variables
        let statusIntervalId = null;
        let collectionsStatusIntervalId = null;
        let selectedCollections = [];
        
        // Initialize folder selection buttons
        document.addEventListener('DOMContentLoaded', function() {
            // Call once on page load to update directories
            updateSelectedFolder();
            
            // Add folder selection functionality to each button
            document.querySelectorAll('.folder-selection-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetInput = document.getElementById(this.dataset.target);
                    
                    if (isPywebview) {
                        // Use pywebview's folder dialog
                        window.pywebview.api.select_folder().then(result => {
                            if (result) {
                                // Update the input field
                                targetInput.value = result;
                                
                                // Update the server
                                fetch('/api/select-folder', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ path: result })
                                });
                            }
                        });
                    } else {
                        // Fallback if not running in pywebview
                        const path = prompt('Enter folder path:', targetInput.value);
                        if (path) {
                            // Update the input field
                            targetInput.value = path;
                            
                            // Update the server
                            fetch('/api/select-folder', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ path: path })
                            });
                        }
                    }
                });
            });
        });
        
        // Options toggle button
        optionsToggleBtn.addEventListener('click', () => {
            if (optionsSection.classList.contains('hidden')) {
                optionsSection.classList.remove('hidden');
                optionsToggleBtn.textContent = 'Hide Options';
            } else {
                optionsSection.classList.add('hidden');
                optionsToggleBtn.textContent = 'Show Options';
            }
        });
        
        // Tab Switching
        tabTours.addEventListener('click', () => {
            tabTours.classList.add('active');
            tabCollections.classList.remove('active');
            contentTours.classList.remove('hidden');
            contentCollections.classList.add('hidden');
        });
        
        tabCollections.addEventListener('click', () => {
            tabCollections.classList.add('active');
            tabTours.classList.remove('active');
            contentCollections.classList.remove('hidden');
            contentTours.classList.add('hidden');
        });
        
        // Anonymous Mode Toggle
        anonymousCheckbox.addEventListener('change', () => {
            if (anonymousCheckbox.checked) {
                loginSection.classList.add('hidden');
                allToursRadio.disabled = true;
                singleTourRadio.checked = true;
                tourIdInput.classList.remove('hidden');
                filterSection.classList.add('hidden');
            } else {
                loginSection.classList.remove('hidden');
                allToursRadio.disabled = false;
                if (allToursRadio.checked) {
                    tourIdInput.classList.add('hidden');
                    filterSection.classList.remove('hidden');
                }
            }
        });
        
        // Tour Selection Type
        allToursRadio.addEventListener('change', () => {
            if (allToursRadio.checked) {
                tourIdInput.classList.add('hidden');
                filterSection.classList.remove('hidden');
            }
        });
        
        singleTourRadio.addEventListener('change', () => {
            if (singleTourRadio.checked) {
                tourIdInput.classList.remove('hidden');
                filterSection.classList.add('hidden');
            }
        });
        
        // Count Tours
        countToursBtn.addEventListener('click', async () => {
            if (anonymousCheckbox.checked) {
                alert('Tour counting is not available in anonymous mode');
                return;
            }
            
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            const filterType = filterTypeSelect.value;
            
            if (!email || !password) {
                alert('Please enter your email and password');
                return;
            }
            
            try {
                countToursBtn.disabled = true;
                countToursBtn.textContent = 'Counting...';
                
                const response = await fetch('/api/tour-counts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, filterType })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                toursCountResult.classList.remove('hidden');
                toursCountText.textContent = `Found ${data.total_tours} tours${filterType !== 'all' ? ' (' + filterTypeSelect.options[filterTypeSelect.selectedIndex].text + ')' : ''}`;
                
            } catch (error) {
                alert('Error counting tours: ' + error.message);
            } finally {
                countToursBtn.disabled = false;
                countToursBtn.textContent = 'Count Tours';
            }
        });
        
        // Export Clear
        exportClearBtn.addEventListener('click', async () => {
            try {
                await fetch('/api/clear', { method: 'POST' });
                resultsSection.classList.add('hidden');
                exportClearBtn.classList.add('hidden');
                resultsTableBody.innerHTML = '';
            } catch (error) {
                console.error('Error clearing results:', error);
            }
        });
        
        // Start Export
        startExportBtn.addEventListener('click', () => {
            // Hide previous results
            resultsSection.classList.add('hidden');
            exportClearBtn.classList.add('hidden');
            
            // Get parameters
            const anonymous = anonymousCheckbox.checked;
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            const tourSelection = allToursRadio.checked ? 'all' : tourIdField.value.trim();
            const filterType = filterTypeSelect.value;
            const outputDir = outputDirInput.value.trim();
            const noPoi = noPoiCheckbox.checked;
            const skipExisting = skipExistingCheckbox.checked;
            const idFilename = idFilenameCheckbox.checked;
            const addDate = addDateCheckbox.checked;
            const maxTitleLength = parseInt(maxTitleLengthInput.value);
            const maxDescLength = parseInt(maxDescLengthInput.value);
            const downloadImages = downloadImagesCheckbox.checked;
            const chunkSize = parseInt(chunkSizeInput.value);
            const chunkStart = parseInt(chunkStartInput.value);
            
            // Validate inputs
            if (!anonymous && (!email || !password)) {
                alert('Please enter your email and password');
                return;
            }
            
            if (tourSelection === 'all' && anonymous) {
                alert('Anonymous mode only supports single tour export');
                return;
            }
            
            if (tourSelection !== 'all' && !tourSelection) {
                alert('Please enter a tour ID');
                return;
            }
            
            // Prepare request data
            const data = {
                anonymous,
                email,
                password,
                tourSelection,
                filterType,
                outputDir,
                noPoi,
                skipExisting,
                idFilename,
                addDate,
                maxTitleLength,
                maxDescLength,
                downloadImages,
                chunkSize,
                chunkStart
            };
            
            // Start the export process
            startProcessing(data);
        });
        
        // Start processing function
        async function startProcessing(data) {
            try {
                // Reset and show status section
                statusSection.classList.remove('hidden');
                statusText.textContent = 'Starting...';
                statusPercent.textContent = '0%';
                statusBar.style.width = '0%';
                statusCompleted.textContent = '0';
                statusTotal.textContent = '0';
                logContent.innerHTML = '';
                floatingProgress.classList.remove('hidden');
                
                // Disable buttons during processing
                startExportBtn.disabled = true;
                countToursBtn.disabled = true;
                
                // Start the processing
                const response = await fetch('/api/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to start processing');
                }
                
                // Start polling for status updates
                if (statusIntervalId) {
                    clearInterval(statusIntervalId);
                }
                
                statusIntervalId = setInterval(checkStatus, 1000);
                
            } catch (error) {
                alert('Error starting export: ' + error.message);
                startExportBtn.disabled = false;
                countToursBtn.disabled = false;
                floatingProgress.classList.add('hidden');
            }
        }
        
        // Check status function
        async function checkStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                // Update status display
                statusText.textContent = status.status.charAt(0).toUpperCase() + status.status.slice(1);
                const percent = Math.round(status.progress * 100);
                statusPercent.textContent = `${percent}%`;
                statusBar.style.width = `${percent}%`;
                statusCompleted.textContent = status.tours_completed;
                statusTotal.textContent = status.tours_found;
                
                // Update floating status
                floatingStatusText.textContent = status.status.charAt(0).toUpperCase() + status.status.slice(1);
                floatingStatusPercent.textContent = `${percent}%`;
                floatingStatusBar.style.width = `${percent}%`;
                floatingStatusCompleted.textContent = status.tours_completed;
                floatingStatusTotal.textContent = status.tours_found;
                
                // Update log
                updateLog(status.log, logContent);
                
                // Check if processing is complete or has an error
                if (status.status === 'completed' || status.status === 'error' || status.status === 'chunk_completed') {
                    clearInterval(statusIntervalId);
                    statusIntervalId = null;
                    startExportBtn.disabled = false;
                    countToursBtn.disabled = false;
                    floatingProgress.classList.add('hidden');
                    
                    // If completed or chunk completed, fetch and display results
                    if (status.status === 'completed' || status.status === 'chunk_completed') {
                        fetchAndDisplayResults();
                    }
                    
                    // If chunk completed, update chunk start for next chunk
                    if (status.status === 'chunk_completed') {
                        chunkStartInput.value = status.next_chunk;
                    }
                }
                
            } catch (error) {
                console.error('Error checking status:', error);
            }
        }
        
        // Fetch and display results
        async function fetchAndDisplayResults() {
            try {
                const response = await fetch('/api/results');
                
                if (!response.ok) {
                    return;
                }
                
                const results = await response.json();
                
                if (!results || results.length === 0) {
                    return;
                }
                
                // Clear previous results
                resultsTableBody.innerHTML = '';
                
                // Add each result to the table
                results.forEach(result => {
                    const row = document.createElement('tr');
                    
                    // Add tour ID
                    const idCell = document.createElement('td');
                    idCell.className = 'px-6 py-4 whitespace-nowrap border-b border-gray-200';
                    idCell.innerHTML = `<div class="text-sm leading-5 text-gray-900">${result.id}</div>`;
                    row.appendChild(idCell);
                    
                    // Add tour name with clearer link styling
                    const nameCell = document.createElement('td');
                    nameCell.className = 'px-6 py-4 whitespace-nowrap border-b border-gray-200';
                    nameCell.innerHTML = `
                        <div class="text-sm leading-5 text-gray-900">
                            <a href="${result.url}" target="_blank" class="text-blue-600 hover:underline truncate max-w-xs inline-block">
                                ${result.name}
                            </a>
                        </div>
                    `;
                    row.appendChild(nameCell);
                    
                    // Add date
                    const dateCell = document.createElement('td');
                    dateCell.className = 'px-6 py-4 whitespace-nowrap border-b border-gray-200';
                    dateCell.innerHTML = `<div class="text-sm leading-5 text-gray-900">${result.date || '-'}</div>`;
                    row.appendChild(dateCell);
                    
                    // Add type
                    const typeCell = document.createElement('td');
                    typeCell.className = 'px-6 py-4 whitespace-nowrap border-b border-gray-200';
                    typeCell.innerHTML = `<div class="text-sm leading-5 text-gray-900">${result.sport || '-'}</div>`;
                    row.appendChild(typeCell);
                    
                    // Add distance
                    const distanceCell = document.createElement('td');
                    distanceCell.className = 'px-6 py-4 whitespace-nowrap border-b border-gray-200';
                    distanceCell.innerHTML = `<div class="text-sm leading-5 text-gray-900">${result.distance_km ? result.distance_km.toFixed(1) + ' km' : '-'}</div>`;
                    row.appendChild(distanceCell);
                    
                    // Add duration
                    const durationCell = document.createElement('td');
                    durationCell.className = 'px-6 py-4 whitespace-nowrap border-b border-gray-200';
                    durationCell.innerHTML = `<div class="text-sm leading-5 text-gray-900">${result.duration ? result.duration.toFixed(1) + ' h' : '-'}</div>`;
                    row.appendChild(durationCell);
                    
                    // Add elevation up - now showing as whole numbers
                    const upCell = document.createElement('td');
                    upCell.className = 'px-6 py-4 whitespace-nowrap border-b border-gray-200';
                    upCell.innerHTML = `<div class="text-sm leading-5 text-gray-900">${result.elevation_up ? Math.round(result.elevation_up) + ' m' : '-'}</div>`;
                    row.appendChild(upCell);
                    
                    // Add elevation down - now showing as whole numbers
                    const downCell = document.createElement('td');
                    downCell.className = 'px-6 py-4 whitespace-nowrap border-b border-gray-200';
                    downCell.innerHTML = `<div class="text-sm leading-5 text-gray-900">${result.elevation_down ? Math.round(result.elevation_down) + ' m' : '-'}</div>`;
                    row.appendChild(downCell);
                    
                    // Add actions
                    const actionsCell = document.createElement('td');
                    actionsCell.className = 'px-6 py-4 whitespace-nowrap border-b border-gray-200';
                    
                    // Create actions content
                    let actionsContent = `
                        <div class="flex space-x-2">
                            <a href="/api/download/${result.id}" class="text-blue-500 hover:text-blue-700">Download</a>
                    `;
                    
                    // Add open folder action if in pywebview
                    if (isPywebview && result.output_dir) {
                        actionsContent += `
                            <a href="#" class="text-blue-500 hover:text-blue-700 open-folder" data-path="${result.output_dir}">
                                Open Folder
                            </a>
                        `;
                    }
                    
                    actionsContent += `</div>`;
                    actionsCell.innerHTML = actionsContent;
                    row.appendChild(actionsCell);
                    
                    // Add row to table
                    resultsTableBody.appendChild(row);
                });
                
                // Add event listeners for open folder links
                if (isPywebview) {
                    document.querySelectorAll('.open-folder').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const path = e.target.getAttribute('data-path');
                            if (path) {
                                // Use pywebview API to open the folder
                                window.pywebview.api.open_folder(path);
                            }
                        });
                    });
                }
                
                // Show results section
                resultsSection.classList.remove('hidden');
                exportClearBtn.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error fetching results:', error);
            }
        }
        
        // Collections functions
        
        // Scrape public collections
        scrapePublicBtn.addEventListener('click', () => {
            const urls = collectionUrlsInput.value.trim().split('\n').filter(url => url.trim());
            
            if (urls.length === 0) {
                alert('Please enter at least one collection URL');
                return;
            }
            
            startCollectionsScraping('/api/collections/public', { urls });
        });
        
        // Clear collections
        clearCollectionsBtn.addEventListener('click', async () => {
            try {
                await fetch('/api/clear-collections', { method: 'POST' });
                collectionsResultsSection.classList.add('hidden');
                downloadCollectionsSection.classList.add('hidden');
                collectionsTableBody.innerHTML = '';
                selectedCollections = [];
            } catch (error) {
                console.error('Error clearing collections:', error);
            }
        });
        
        // Download collection tours
        downloadCollectionToursBtn.addEventListener('click', async () => {
            if (selectedCollections.length === 0) {
                alert('Please select at least one collection');
                return;
            }
            
            const outputDir = collectionsOutputDirInput.value.trim();
            const includeMetadata = collectionsIncludeMetadataCheckbox.checked;
            const downloadImages = collectionsDownloadImagesCheckbox.checked;
            
            // GPX options
            const gpxOptions = {
                noPoi: collectionsNoPoiCheckbox.checked,
                skipExisting: collectionsSkipExistingCheckbox.checked,
                addDate: collectionsAddDateCheckbox.checked,
                maxTitleLength: -1,
                maxDescLength: -1
            };
            
            // Determine common user ID from collections if possible
            let userId = null;
            // First, try to get user ID from creator field
            for (const collection of selectedCollections) {
                if (collection.creator && collection.creator.id) {
                    userId = collection.creator.id;
                    break;
                }
            }
            
            // If no user ID found from creator, try to extract from URL
            if (!userId) {
                for (const collection of selectedCollections) {
                    if (collection.url) {
                        const match = collection.url.match(/\/user\/([^\/]+)/);
                        if (match && match[1]) {
                            userId = match[1];
                            break;
                        }
                    }
                }
            }
            
            const data = {
                collections: selectedCollections,
                outputDir,
                includeMetadata,
                downloadImages,
                gpxOptions,
                userId: userId  // Add user ID to the request
            };
            
            startCollectionTourDownload(data);
        });
        
        // Start collections scraping
        async function startCollectionsScraping(endpoint, data) {
            try {
                // Reset and show status section
                collectionsStatusSection.classList.remove('hidden');
                collectionsStatusText.textContent = 'Starting...';
                collectionsStatusPercent.textContent = '0%';
                collectionsStatusBar.style.width = '0%';
                collectionsStatusCompleted.textContent = '0';
                collectionsStatusTotal.textContent = '0';
                collectionsLogContent.innerHTML = '';
                floatingProgress.classList.remove('hidden');
                
                // Disable buttons during processing
                scrapePublicBtn.disabled = true;
                
                // Start the scraping
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to start scraping');
                }
                
                // Start polling for status updates
                if (collectionsStatusIntervalId) {
                    clearInterval(collectionsStatusIntervalId);
                }
                
                collectionsStatusIntervalId = setInterval(checkCollectionsStatus, 1000);
                
            } catch (error) {
                alert('Error starting scraping: ' + error.message);
                scrapePublicBtn.disabled = false;
                floatingProgress.classList.add('hidden');
            }
        }
        
        // Check collections status
        async function checkCollectionsStatus() {
            try {
                const response = await fetch('/api/collections-status');
                const status = await response.json();
                
                // Update status display
                collectionsStatusText.textContent = status.status.charAt(0).toUpperCase() + status.status.slice(1);
                const percent = Math.round(status.progress * 100);
                collectionsStatusPercent.textContent = `${percent}%`;
                collectionsStatusBar.style.width = `${percent}%`;
                collectionsStatusCompleted.textContent = status.collections_completed;
                collectionsStatusTotal.textContent = status.collections_found;
                
                // Update floating status
                floatingStatusText.textContent = status.status.charAt(0).toUpperCase() + status.status.slice(1);
                floatingStatusPercent.textContent = `${percent}%`;
                floatingStatusBar.style.width = `${percent}%`;
                floatingStatusCompleted.textContent = status.collections_completed;
                floatingStatusTotal.textContent = status.collections_found;
                
                // Update log
                updateLog(status.log, collectionsLogContent);
                
                // Check if processing is complete or has an error
                if (status.status === 'completed' || status.status === 'error') {
                    clearInterval(collectionsStatusIntervalId);
                    collectionsStatusIntervalId = null;
                    scrapePublicBtn.disabled = false;
                    enhanceCollectionsBtn.disabled = false;
                    downloadCollectionToursBtn.disabled = false;
                    floatingProgress.classList.add('hidden');
                    
                    // If completed, fetch and display results
                    if (status.status === 'completed') {
                        // Store currently selected collection IDs before refreshing
                        const selectedIds = selectedCollections.map(c => c.id);
                        
                        // Wait a moment to ensure the backend has finished writing all data
                        setTimeout(() => {
                            fetchAndDisplayCollections(selectedIds);
                            
                            // Show success message for enhancement
                            if (status.log && status.log.some(entry => entry.includes("Enhancement completed"))) {
                                alert("Collections successfully enhanced! The status badges now show updated enhancement status.");
                            }
                        }, 500);
                    }
                }
                
            } catch (error) {
                console.error('Error checking collections status:', error);
            }
        }
        
        // Fetch and display collections
        async function fetchAndDisplayCollections(selectedIds = []) {
            try {
                const response = await fetch('/api/collections-results');
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                
                const collections = await response.json();
                
                // Clear existing collections
                collectionsTableBody.innerHTML = '';
                
                // We'll keep track of selected items after refresh
                const newSelectedCollections = [];
                
                // Reset button states
                clearCollectionsBtn.disabled = true;
                downloadCollectionToursBtn.disabled = true;
                
                if (collections.length === 0) {
                    collectionsTableBody.innerHTML = '<tr><td colspan="6" class="text-center">No collections found</td></tr>';
                    selectedCollections = [];
                    return;
                }
                
                // Sort collections by name
                collections.sort((a, b) => {
                    const nameA = a.name || '';
                    const nameB = b.name || '';
                    return nameA.localeCompare(nameB);
                });
                
                // Add collections to table
                collections.forEach(collection => {
                    const row = document.createElement('tr');
                    
                    // Checkbox cell
                    const checkboxCell = document.createElement('td');
                    checkboxCell.className = 'px-6 py-4 whitespace-nowrap border-b border-gray-200';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.classList.add('form-check-input');
                    checkbox.dataset.collectionId = collection.id;
                    
                    // Check the box if this collection was previously selected
                    if (selectedIds.includes(collection.id)) {
                        checkbox.checked = true;
                        newSelectedCollections.push(collection);
                    }
                    
                    checkbox.addEventListener('change', function() {
                        updateSelectedCollections();
                    });
                    checkboxCell.appendChild(checkbox);
                    row.appendChild(checkboxCell);
                    
                    // Name cell
                    const nameCell = document.createElement('td');
                    nameCell.className = 'px-6 py-4 whitespace-nowrap border-b border-gray-200';
                    
                    const nameLink = document.createElement('a');
                    nameLink.href = collection.url || '#';
                    nameLink.target = '_blank';
                    nameLink.className = 'text-blue-500 hover:underline';
                    nameLink.textContent = collection.name || `Collection ${collection.id}`;
                    nameCell.appendChild(nameLink);
                    row.appendChild(nameCell);
                    
                    // ID cell
                    const idCell = document.createElement('td');
                    idCell.className = 'px-6 py-4 whitespace-nowrap border-b border-gray-200';
                    idCell.textContent = collection.id || '';
                    row.appendChild(idCell);
                    
                    // Slug cell
                    const slugCell = document.createElement('td');
                    slugCell.className = 'px-6 py-4 whitespace-nowrap border-b border-gray-200';
                    const slug = collection.slug || extractSlug(collection.url, collection.name);
                    slugCell.textContent = slug;
                    row.appendChild(slugCell);
                    
                    // Tours count cell
                    const toursCountCell = document.createElement('td');
                    toursCountCell.className = 'px-6 py-4 whitespace-nowrap border-b border-gray-200';
                    const toursCount = collection.tours_count || collection.tours?.length || 0;
                    toursCountCell.textContent = toursCount;
                    row.appendChild(toursCountCell);
                    
                    // Enhanced status cell
                    const enhancedCell = document.createElement('td');
                    enhancedCell.className = 'px-6 py-4 whitespace-nowrap border-b border-gray-200 text-center';
                    
                    // Determine enhancement status
                    let isEnhanced = false;
                    
                    // First check explicit flag
                    if (collection.is_enhanced === true) {
                        isEnhanced = true;
                    } else if (collection.tours && collection.tours.length > 0) {
                        // Otherwise check if tours have enhanced data
                        const enhancedTourCount = collection.tours.filter(tour => 
                            (tour.distance_km !== undefined || tour.distance !== undefined) && 
                            !tour.name.startsWith(`Tour ${tour.id}`)
                        ).length;
                        
                        const totalTours = collection.tours.length;
                        // Consider enhanced if > 80% of tours have enhanced data
                        isEnhanced = totalTours > 0 && enhancedTourCount / totalTours > 0.8;
                    }
                    
                    // Add enhancement status to collection for easier reference
                    collection.enhancementStatus = isEnhanced ? 'enhanced' : 'basic';
                    
                    // Create the badge
                    const badge = document.createElement('span');
                    badge.className = isEnhanced ? 'badge bg-success' : 'badge bg-secondary';
                    badge.textContent = isEnhanced ? 'ENHANCED' : 'BASIC';
                    enhancedCell.appendChild(badge);
                    row.appendChild(enhancedCell);
                    
                    collectionsTableBody.appendChild(row);
                });
                
                // Show collections results section and download section
                collectionsResultsSection.classList.remove('hidden');
                downloadCollectionsSection.classList.remove('hidden');
                enhanceCollectionsBtn.classList.remove('hidden');
                
                // Disable enhance button if all collections are already enhanced
                const needsEnhancement = collections.some(collection => collection.enhancementStatus === 'basic');
                enhanceCollectionsBtn.disabled = !needsEnhancement;
                
                // Update selected collections
                selectedCollections = newSelectedCollections;
                
            } catch (error) {
                console.error('Error fetching collections:', error);
                collectionsTableBody.innerHTML = `<tr><td colspan="6" class="text-center">Error fetching collections: ${error.message}</td></tr>`;
            }
        }
        
        // Function to update selected collections
        function updateSelectedCollections() {
            // Get all checked checkboxes
            const checkedBoxes = document.querySelectorAll('#collections-table-body input.form-check-input:checked');
            
            // Clear selected collections array
            selectedCollections = [];
            
            // Get the collections data from the server
            fetch('/api/collections-results')
                .then(response => response.json())
                .then(collections => {
                    // Filter collections based on checked boxes
                    checkedBoxes.forEach(checkbox => {
                        const collectionId = checkbox.dataset.collectionId;
                        const collection = collections.find(c => c.id === collectionId);
                        if (collection) {
                            selectedCollections.push(collection);
                        }
                    });
                    
                    // Update UI based on selections
                    clearCollectionsBtn.disabled = selectedCollections.length === 0;
                    downloadCollectionToursBtn.disabled = selectedCollections.length === 0;
                    
                    // Update enhance button visibility
                    const hasEnhanceableCollections = selectedCollections.some(collection => 
                        collection.enhancementStatus === 'basic' || !collection.is_enhanced
                    );
                    
                    if (hasEnhanceableCollections && selectedCollections.length > 0) {
                        enhanceCollectionsBtn.classList.remove('hidden');
                    } else {
                        enhanceCollectionsBtn.classList.add('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error updating selected collections:', error);
                });
        }
        
        // Start downloading collection tours
        async function startCollectionTourDownload(data) {
            try {
                // Reset and show status section
                statusSection.classList.remove('hidden');
                statusText.textContent = 'Starting...';
                statusPercent.textContent = '0%';
                statusBar.style.width = '0%';
                statusCompleted.textContent = '0';
                statusTotal.textContent = '0';
                logContent.innerHTML = '';
                floatingProgress.classList.remove('hidden');
                
                // Disable buttons during processing
                downloadCollectionToursBtn.disabled = true;
                
                // Start the download
                const response = await fetch('/api/download-collection-tours', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to start download');
                }
                
                // Start polling for status updates
                if (statusIntervalId) {
                    clearInterval(statusIntervalId);
                }
                
                statusIntervalId = setInterval(checkStatus, 1000);
                
            } catch (error) {
                alert('Error starting download: ' + error.message);
                downloadCollectionToursBtn.disabled = false;
                floatingProgress.classList.add('hidden');
            }
        }
        
        // Update log helper function
        function updateLog(log, container) {
            if (!log || !log.length) return;
            
            // Create content
            const content = log.join('<br>');
            
            // Update container
            container.innerHTML = content;
            
            // Scroll to bottom
            container.parentElement.scrollTop = container.parentElement.scrollHeight;
        }
        
        // Initialize some elements
        document.addEventListener('DOMContentLoaded', () => {
            // Add listeners for buttons that need to be visible/hidden dynamically
            
            // When selecting tour by ID, hide the filter section
            singleTourRadio.addEventListener('change', () => {
                if (singleTourRadio.checked) {
                    filterSection.classList.add('hidden');
                    tourIdInput.classList.remove('hidden');
                }
            });
            
            // Toggle filter section visibility based on tour selection
            allToursRadio.addEventListener('change', () => {
                if (allToursRadio.checked) {
                    filterSection.classList.remove('hidden');
                    tourIdInput.classList.add('hidden');
                }
            });
            
            // Initialize based on default selection
            if (singleTourRadio.checked) {
                tourIdInput.classList.remove('hidden');
                filterSection.classList.add('hidden');
            }
            
            // Update folder inputs on page load
            updateSelectedFolder();
            
            // Set up folder selection buttons to work with pywebview
            document.querySelectorAll('.folder-selection-btn').forEach(btn => {
                // Show browse buttons only in desktop mode
                btn.style.display = isPywebview ? 'inline-block' : 'none';
            });
        });

        // Enhance Collections button
        const enhanceCollectionsBtn = document.getElementById('enhance-collections-btn');
        
        // Function to update Enhance button visibility
        function updateEnhanceButtonVisibility() {
            // Check if we have any collections that need enhancement
            const hasEnhanceableCollections = selectedCollections.some(collection => 
                collection.enhancementStatus === 'basic' || collection.enhancementStatus === 'partial'
            );
            
            // Only show the enhance button if there are collections that need enhancement
            if (hasEnhanceableCollections && selectedCollections.length > 0) {
                enhanceCollectionsBtn.classList.remove('hidden');
            } else {
                enhanceCollectionsBtn.classList.add('hidden');
            }
        }
        
        // Enhance Collections button click handler
        enhanceCollectionsBtn.addEventListener('click', async () => {
            if (selectedCollections.length === 0) {
                alert('Please select at least one collection to enhance');
                return;
            }
            
            // Get the user ID from the selected collections
            let userId = null;
            
            // First try to get user ID from creator field
            for (const collection of selectedCollections) {
                if (collection.creator && collection.creator.id) {
                    userId = collection.creator.id;
                    break;
                }
            }
            
            // If no user ID found, try to extract from URL
            if (!userId) {
                for (const collection of selectedCollections) {
                    if (collection.url) {
                        const match = collection.url.match(/\/user\/([^\/]+)/);
                        if (match && match[1]) {
                            userId = match[1];
                            break;
                        }
                    }
                }
            }
            
            if (!userId) {
                alert('Could not determine user ID from selected collections');
                return;
            }
            
            // Start the enhancement process
            startCollectionEnhancement(userId);
        });
        
        // Start collection enhancement process
        async function startCollectionEnhancement(userId) {
            try {
                // Reset and show status section
                collectionsStatusSection.classList.remove('hidden');
                collectionsStatusText.textContent = 'Starting enhancement...';
                collectionsStatusPercent.textContent = '0%';
                collectionsStatusBar.style.width = '0%';
                collectionsStatusCompleted.textContent = '0';
                collectionsStatusTotal.textContent = '0';
                collectionsLogContent.innerHTML = '';
                floatingProgress.classList.remove('hidden');
                
                // Disable buttons during processing
                enhanceCollectionsBtn.disabled = true;
                downloadCollectionToursBtn.disabled = true;
                
                // Start the enhancement process
                const response = await fetch('/api/enhance-collections', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to start enhancement');
                }
                
                // Start polling for status updates
                if (collectionsStatusIntervalId) {
                    clearInterval(collectionsStatusIntervalId);
                }
                
                collectionsStatusIntervalId = setInterval(checkCollectionsStatus, 1000);
                
            } catch (error) {
                alert('Error starting enhancement: ' + error.message);
                enhanceCollectionsBtn.disabled = false;
                downloadCollectionToursBtn.disabled = false;
                floatingProgress.classList.add('hidden');
            }
        }
    </script>
</body>
</html>